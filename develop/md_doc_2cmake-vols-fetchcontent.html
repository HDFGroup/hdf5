<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HDF5: Building and testing HDF5 VOL connectors with CMake FetchContent</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="hdf5doxy.css" rel="stylesheet" type="text/css">
<!-- <link href="hdf5doxy.css" rel="stylesheet" type="text/css"/>
 -->
<script type="text/javascript" src="hdf5_navtree_hacks.js"></script>
</head>
<body>
<div style="background:#FFDDDD;font-size:120%;text-align:center;margin:0;padding:5px">Please, help us to better serve our user community by answering the following short survey:  <a href="https://www.hdfgroup.org/website-survey/">https://www.hdfgroup.org/website-survey/</a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="HDFG-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="https://www.hdfgroup.org">HDF5</a>
   &#160;<span id="projectnumber">1.15.0.ce99ebc</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2cmake-vols-fetchcontent.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Building and testing HDF5 VOL connectors with CMake FetchContent</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md26"></a> This document details the process of using CMake options to build and test an HDF5 VOL connector alongside the HDF5 library when building HDF5 from source. There are several benefits that this may provide, but among them are the following:</p>
<ul>
<li>A VOL connector built this way can be tested at the same time that HDF5 is, which eliminates the need to have a multi-step build process where one builds HDF5, uses it to build the VOL connector and then uses the external <a href="https://github.com/hdfGroup/vol-tests">HDF5 VOL tests</a> repository to test their connector.</li>
<li>Building VOL connectors in this manner will usually install the built connector library alongside the HDF5 library, allowing future opportunities for HDF5 to set a default plugin path such that the HDF5_PLUGIN_PATH environment variable doesn't need to be set.</li>
</ul>
<h1><a class="anchor" id="autotoc_md27"></a>
Building</h1>
<p>To enable building of an HDF5 VOL connector using HDF5's CMake functionality, a CMake variable must first be set: </p><pre class="fragment">HDF5_VOL_ALLOW_EXTERNAL (Default: "NO")
    This variable is a string that specifies the manner in which the source code for
    an external VOL connector will be retrieved. This variable must be set
    to "GIT" for building external VOL connectors from a Github repository, or
    set to "LOCAL_DIR" to build from a local source directory.
</pre><h2><a class="anchor" id="autotoc_md28"></a>
Building</h2>
<p>If the <code>HDF5_VOL_ALLOW_EXTERNAL</code> option is set to "GIT", the CMake cache will be populated with a predefined (currently 10) amount of new variables, named: </p><pre class="fragment">HDF5_VOL_URL01
HDF5_VOL_URL02
HDF5_VOL_URL03
...
</pre><p> For each of these variables, a URL that points to an HDF5 VOL connector Git repository can be specified. These URLs should currently be HTTPS URLs. For example, to specify the HDF5 Asynchronous I/O VOL Connector developed by the ECP team, one can provide the following option to <code>cmake</code>: </p><pre class="fragment">-DHDF5_VOL_URL01=https://github.com/hpc-io/vol-async.git
</pre><p> For each URL specified, HDF5's CMake code will attempt to use CMake's <a href="https://cmake.org/cmake/help/latest/module/FetchContent.html">FetchContent</a> functionality to retrieve the source code for a VOL connector pointed to by that URL and will try to build that VOL connector as part of the HDF5 library build process.</p>
<p>If <code>HDF5_VOL_ALLOW_EXTERNAL</code> is instead set to "LOCAL_DIR", then the CMake cache will instead be populated with the variables: </p><pre class="fragment">HDF5_VOL_PATH01
HDF5_VOL_PATH02
HDF5_VOL_PATH03
...
</pre><p> For each of these variables, an absolute path that points to a local directory containing source code for an HDF5 VOL connector can be specified. For example, to specify a local clone of the REST VOL connector stored under one's home directory, one can provide the following option to <code>cmake</code>: </p><pre class="fragment">-DHDF5_VOL_PATH01=/home/vol-rest
</pre><p> Regardless of the method used to obtain the VOL source code, the VOL connector must be able to be built by CMake and currently must have a CMakeLists.txt file in the top level of the source tree in order to be buildable by this process. If the source code for a VOL connector is successfully retrieved, the HDF5 build's CMake cache will be populated with variables from the VOL connector's CMake code, as if one were building the connector by itself. This gives one the ability to customize the build of the connector as usual.</p>
<p>The CMake cache will also be populated with a few new variables for each VOL connector that was successfully retrieved. To generate these variables, the CMake code first creates an internal name for the VOL connector. If the source was retrieved from a URL, then the name is generated by stripping off the last part of the Git repository URL given for the connector, removing the ".git" suffix and any whitespace and then upper-casing the result. For example, the name of the VOL connector located at the URL <a href="https://github.com/hpc-io/vol-async.git">https://github.com/hpc-io/vol-async.git</a> would become "VOL-ASYNC". If the source was retrieved from a local directory, then the source directory's name is trimmed of whitespace, upper-cased, and has any trailing slashes removed.</p>
<p>After the VOL's internal name is generated, the following new variables get created: </p><pre class="fragment">HDF5_VOL_&lt;VOL name&gt;_NAME (Default: "")
    This variable specifies the string that should be used when setting the
    HDF5_VOL_CONNECTOR environment variable for testing the VOL connector
    with the CMake-internal name '&lt;VOL name&gt;'. The value for this variable
    can be determined according to the canonical name given to the connector
    by the connector's author(s), as well as any extra info that needs to be
    passed to the connector for its configuration (see example below). This
    variable must be set in order for the VOL connector to be testable with
    HDF5's tests.

HDF5_VOL_&lt;VOL name&gt;_CMAKE_PACKAGE_NAME (Default: "&lt;lowercased &lt;VOL name&gt;&gt;")
    This variable specifies the exact name that would be passed to CMake
    find_package(...) calls for the VOL connector in question. It is used as
    the dependency name when making CMake FetchContent calls to try to ensure
    that any other VOL connectors to be built which depend on this VOL connector
    can make find_package(...) calls for this VOL connector at configure time.
    By default, this variable is set to a lowercased version of the internal
    name generated for the VOL connector (described above).

HDF5_VOL_&lt;VOL name&gt;_TEST_PARALLEL (Default: OFF)
    This variable determines whether the VOL connector with the CMake-internal
    name '&lt;VOL name&gt;' should be tested against HDF5's parallel tests.
</pre><p> If the source was retrieved from a Git URL, then the following variable will additionally be created: </p><pre class="fragment">HDF5_VOL_&lt;VOL name&gt;_BRANCH (Default: "main")
    This variable specifies the git branch name or tag to use when fetching
    the source code for the VOL connector with the CMake-internal name
    '&lt;VOL name&gt;'.
</pre><p> As an example, this would create the following variables for the previously-mentioned VOL connector if it is retrieved from a URL: </p><pre class="fragment">HDF5_VOL_VOL-ASYNC_NAME                  ""
HDF5_VOL_VOL-ASYNC_CMAKE_PACKAGE_NAME    "vol-async"
HDF5_VOL_VOL-ASYNC_BRANCH                "main"
HDF5_VOL_VOL-ASYNC_TEST_PARALLEL         OFF
</pre><p> <b>NOTE</b> If a VOL connector requires extra information to be passed in its HDF5_VOL_&lt;VOL name&gt;_NAME variable and that information contains any semicolons, those semicolons should be escaped with a single backslash so that CMake doesn't parse the string as a list. If <code>cmake</code> is run from a shell, extra care may need to be taken when escaping the semicolons depending on how the shell interprets backslashes.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Example - Build and test HDF5 Asynchronous I/O VOL connector from GIT</h2>
<p>Assuming that the HDF5 source code has been checked out and a build directory has been created, running the following cmake command from that build directory will retrieve, build and test the HDF5 Asynchronous I/O VOL connector while building HDF5. Note that <code>[<a class="el" href="namespacehdf5.html">hdf5</a> options]</code> represents other build options that would typically be passed when building HDF5, such as <code>CMAKE_INSTALL_PREFIX</code>, <code>HDF5_BUILD_CPP_LIB</code>, etc. </p><pre class="fragment">cmake [hdf5 options]
  -DHDF5_ENABLE_THREADSAFE=ON
  -DHDF5_ENABLE_PARALLEL=ON
  -DALLOW_UNSUPPORTED=ON
  -DHDF5_TEST_API=ON
  -DHDF5_VOL_ALLOW_EXTERNAL="GIT"
  -DHDF5_VOL_URL01=https://github.com/hpc-io/vol-async.git
  -DHDF5_VOL_VOL-ASYNC_BRANCH=develop
  -DHDF5_VOL_VOL-ASYNC_NAME="async under_vol=0\;under_info={}"
  -DHDF5_VOL_VOL-ASYNC_TEST_PARALLEL=ON
  ..
</pre><p> Here, we are specifying that:</p>
<ul>
<li>HDF5 should be built with thread-safety enabled (required by Async VOL connector)</li>
<li>HDF5 should be built with parallel enabled (required by Async VOL connector)</li>
<li>Allow unsupported HDF5 combinations (thread-safety and HL, which is on by default)</li>
<li>Enable the API tests so that they can be tested with the Async VOL connector</li>
<li>Build and use the HDF5 Asynchronous I/O VOL connector, located at <a href="https://github.com/hpc-io/vol-async.git">https://github.com/hpc-io/vol-async.git</a></li>
<li>Clone the Asynchronous I/O VOL connector from the repository's 'develop' branch</li>
<li>When testing the Asynchronous I/O VOL connector, the <code>HDF5_VOL_CONNECTOR</code> environment variable should be set to "async under_vol=0\;under_info={}", which specifies that the VOL connector with the canonical name "async" should be loaded and it should be passed the string "under_vol=0;under_info={}" for its configuration (note the backslash-escaping of semicolons in the string provided)</li>
<li>The Asynchronous I/O VOL connector should be tested against HDF5's parallel API tests</li>
</ul>
<p>Note that this also assumes that the Asynchronous I/O VOL connector's <a href="https://hdf5-vol-async.readthedocs.io/en/latest/gettingstarted.html#preparation">other dependencies</a> are installed on the system in a way that CMake can find them. If that is not the case, the locations for these dependencies may need to be provided to CMake by passing extra options, such as: </p><pre class="fragment">-DABT_INCLUDE_DIR=/path/to/argobots/build/include
-DABT_LIBRARY=/path/to/argbots/build/lib/libabt.so
</pre><p> which would help CMake find an argobots installation in a non-standard location.</p>
<h1><a class="anchor" id="autotoc_md30"></a>
Testing</h1>
<p>To facilitate testing of HDF5 VOL connectors when building HDF5, tests from the <a href="https://github.com/hdfGroup/vol-tests">HDF5 VOL tests</a> repository were integrated back into the library and the following new CMake options were added to HDF5 builds for the 1.14.1 release: </p><pre class="fragment">HDF5_TEST_API (Default: OFF)
    This variable determines whether the HDF5 API tests will be built and tested.

HDF5_TEST_API_INSTALL (Default: OFF)
    This variable determines whether the HDF5 API test executables will be installed
    on the system alongside the HDF5 library.

HDF5_TEST_API_ENABLE_ASYNC (Default: OFF)
    This variable determines whether the HDF5 Asynchronous I/O API tests will be
    built and tested. These tests will only run if a VOL connector reports that
    it supports asynchronous I/O operations when queried via the H5Pget_vol_cap_flags
    API routine.

HDF5_TEST_API_ENABLE_DRIVER (Default: OFF)
    This variable determines whether the HDF5 API test driver program will be
    built and used for testing. This driver program is useful when a VOL connector
    uses a client/server model where the server program needs to be up and running
    before the VOL connector can function. This option is currently not functional.
</pre><p> When the <code>HDF5_TEST_API</code> option is set to ON, HDF5's CMake code builds and tests the new API tests using the native VOL connector. When one or more external VOL connectors are built successfully with the process described in this document, the CMake code will duplicate some of these API tests by adding separate versions of the tests (for each VOL connector that was built) that set the <code>HDF5_VOL_CONNECTOR</code> environment variable to the value specified for the HDF5_VOL_&lt;VOL name&gt;_NAME variable for each external VOL connector at build time. Running the <code>ctest</code> command will then run these new tests which load and run with each VOL connector that was built in turn. When run via the <code>ctest</code> command, the new tests typically follow the naming scheme: </p><pre class="fragment">HDF5_VOL_&lt;VOL name lowercase&gt;-h5_api_test_&lt;test name&gt;
HDF5_VOL_&lt;VOL name lowercase&gt;-h5_api_test_parallel_&lt;test name&gt;
</pre><p> <b>NOTE</b> If dependencies of a built VOL connector are installed on the system in a non-standard location that would typically require one to set <code>LD_LIBRARY_PATH</code> or similar, one should ensure that those environment variables are set before running tests. Otherwise, the tests that run with that connector will likely fail due to being unable to load the necessary libraries for its dependencies. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
