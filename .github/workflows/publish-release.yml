name: hdf5 publishrelease

# Controls when the action will run. Triggers the workflow on a schedule
on:
  workflow_dispatch:
    inputs:
      use_tag:
        description: 'HDF5 Release version tag'
        type: string
        required: true
      target_dir:
        description: 'HDF5 target bucket directory'
        type: string
        required: true
    permissions:
      contents: read
    
    # A workflow run is made up of one or more jobs that can run sequentially or
    # in parallel.
jobs:
  publish-tag:
    runs-on: ubuntu-latest
    steps:
        # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
        - name: Get Sources
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
          with:
            fetch-depth: 0
            ref: '${{ github.head_ref || github.ref_name }}'

        - name: Get hdf5 release
          uses: dsaltares/fetch-gh-release-asset@master
          with:
            repo: 'HDFGroup/hdf5'
            version: 'tags/${{ inputs.use_tag }}'
            regex: true
            target: 'HDF5/'
            file: '${{ inputs.use_hdf }}-*.*'

        - name: Setup AWS CLI
          uses: aws-actions/configure-aws-credentials@v1
          with:
                 aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                 aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                 aws-region: ${{ secrets.AWS_REGION }}

        - name: Sync release to S3 bucket
          run: |
                aws s3 sync ./HDF5 s3://${{ secrets.AWS_S3_BUCKET }}/${{ vars.TARGET_PATH }}/${{ inputs.target_dir }}/downloads --delete

        - name: Uncompress source (Linux)
          run: tar -zxvf ${{ github.workspace }}/${{ inputs.use_hdf }}.doxygen.tar.gz

        - name: Sync userguide to S3 bucket
          run: |
                aws s3 sync ./doxygen s3://${{ secrets.AWS_S3_BUCKET }}/${{ vars.TARGET_PATH }}/${{ inputs.target_dir }}/documentation --delete

